upstream auth-service {
    zone upstream-imageApp 64k;
    least_conn;
    server auth-service:8080 max_fails=3 fail_timeout=60 weight=1;
}

upstream profile-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server profile-service:8085 max_fails=3 fail_timeout=60 weight=1;
}

upstream messages-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server messages-service:8002 max_fails=3 fail_timeout=60 weight=1;
}

upstream post-service {
    zone upstream-post 64k;
    least_conn;
    server post-service:8086 max_fails=3 fail_timeout=60 weight=1;
}

upstream follower-service {
    zone upstream-follower 64k;
    least_conn;
    server followers-microservice:8088 max_fails=3 fail_timeout=60 weight=1;
}

upstream story-service {
    zone upstream-story 64k;
    least_conn;
    server story-service:8083 max_fails=3 fail_timeout=60 weight=1;
}

upstream admin-service {
    zone upstream-admin 64k;
    least_conn;
    server admin-service:8089 max_fails=3 fail_timeout=60 weight=1;
}

upstream agent-service {
    zone upstream-agent 64k;
    least_conn;
    server agent-service:8001 max_fails=3 fail_timeout=60 weight=1;
}

upstream profile-management-service {
    zone upstream-profile-management 64k;
    least_conn;
    server profile-management-service:8087 max_fails=3 fail_timeout=60 weight=1;
}

server {
    listen 80;
    server_name localhost;
    # listen 443 ssl;
    # ssl_certificate     ../certificates/certificate.pem;
    # ssl_certificate_key ../certificates/certificate-key.pem;

    ###########################################################################################################
                                            # ADMIN SERVICE
    ###########################################################################################################

    location /verificationRequest/getAll {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://admin-service/verificationRequest/getAll;
    }

    location /verificationRequest {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://admin-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /verificationRequest/accept {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://admin-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /verificationRequest/decline {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://admin-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /admin/images {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://admin-service;
        rewrite ^/(.*)$ /$1 break;
    }

    ###########################################################################################################
    ###########################################################################################################

    ###########################################################################################################
                                            # AGENT SERVICE
    ###########################################################################################################

    location /campaigns/create {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://agent-service/campaigns/create;
    }

    location /campaigns/getAll {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://agent-service/campaigns/getAll;
    }

    # location /campaigns/delete {
    #     limit_except GET POST PUT OPTIONS DELETE { deny all; }
    #     proxy_pass http://agent-service;
    #     rewrite ^/(.*)$ /$1 break;
    # }

    ###########################################################################################################
    ###########################################################################################################

    ###########################################################################################################
                                            # AUTH SERVICE
    ###########################################################################################################

    location /auth {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://auth-service;
    }

     location /auth/is-authenticated {
        internal;
        proxy_pass http://auth-service;
        proxy_pass_request_body off;
        proxy_set_header Authorization $http_authorization;
     }

    location /auth/has-admin-role {
        internal;
        proxy_pass http://auth-service;
        proxy_pass_request_body off;
        proxy_set_header Authorization $http_authorization;
    }

    location /auth/has-system-user-role {
        internal;
        proxy_pass http://auth-service;
        proxy_pass_request_body off;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/blockUser {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://auth-service/api/blockUser;
    }

    location /api/createUser {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://auth-service/api/createUser;
    }

    location /api/login-details/isValidLogin {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://auth-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /api/login-details {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://auth-service/api/login-details;
    }

    ###########################################################################################################
    ###########################################################################################################

    ###########################################################################################################
                                            # FOLLOWER SERVICE
    ###########################################################################################################

    location /users/addNode {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/getFollowers {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/getFollowing {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service;
        rewrite ^/(.*)$ /$1 break;
    }
    location /users/getRequests {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/follow {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/unfollow {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/acceptRequest {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/isFollowing {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/checkFollowing {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service;
        rewrite ^/(.*)$ /$1 break;
    }

    ###########################################################################################################
    ###########################################################################################################
     ###########################################################################################################
                                            # MESSAGES SERVICE
    ###########################################################################################################

    location /messages/add {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://messages-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /messages/getAll {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://messages-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /conversations/create {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://messages-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /conversations/getAll {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://messages-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /conversations {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://messages-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /images/upload {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://messages-service;
        rewrite ^/(.*)$ /$1 break;
    }

    ###########################################################################################################
    ###########################################################################################################

    ###########################################################################################################
                                            # POST SERVICE
    ###########################################################################################################

    location /comments {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/comments;
    }   

    location /posts/create {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/posts/create;
    }

    location /posts/save {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/posts/save;
    }

    location /posts/all-archived {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /posts/edit-archived {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/posts/edit-archived;
    }

    location /campaigns/createCampaign {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/campaigns/createCampaign;
    }

    location /campaigns/createRequest {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/campaigns/createRequest;
    }

    location /campaigns/updateCampaign {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/campaigns/updateCampaign;
    }

    location /campaigns/addInfluencer {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/campaigns/addInfluencer;
    }

    location /posts/getByKey {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /posts/getById {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /campaigns/getById {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /campaigns/getByInfluencerId {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /posts/getByUserId {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /posts/feed {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /posts/public {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/posts/public;
    }

    location /posts/liked {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /campaigns/getUserCampaigns {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /campaigns/getInfluencerCampaigns {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /campaigns/getUserCampaignReqs {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /campaigns/getUserTemporaryCampaigns {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /posts/disliked {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /posts/reported {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/posts/reported;
    }

    location /posts/delete {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/posts/delete;
    }

    location /campaigns/delete {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/campaigns/delete;
    }

    location /campaigns/deleteReq {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/campaigns/deleteReq;
    }

    location /posts/public-tags {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/posts/public-tags;
    }

    location /posts/public-locations {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/posts/public-locations;
    }

    location /posts/signed-in-tags {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /posts/signed-in-locations {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /upload {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/upload;
    }

    location /like-post {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/like-post;
    }

    location /dislike-post {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/dislike-post;
    }

    location /report-post {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/report-post;
    }

    location /posts/images {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    ###########################################################################################################
    ###########################################################################################################
    
    ###########################################################################################################
                                            # PROFILE MANAGEMENT SERVICE
    ###########################################################################################################

    location /users/blocked {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/block {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/unblock {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/isBlocked {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/isMuted {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }
    
    location /users/mute {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/unmute {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/muted {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/subscribe {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/unsubscribe {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/subscribers {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/isSubscribed {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/addCloseFriend {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/removeCloseFriend {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/closeFriend {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-management-service;
        rewrite ^/(.*)$ /$1 break;
    }

    ###########################################################################################################
    ###########################################################################################################

    ###########################################################################################################
                                            # PROFILE SERVICE
    ###########################################################################################################

    location /sysusers/create {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/sysusers/create;
    }

    location /sysusers/update {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/sysusers/update;
    }

    location /sysusers/getAll {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/sysusers/getAll;
    }

    location /sysusers/getAllUsernames {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/sysusers/getAllUsernames;
    }

    location /sysusers/getUserId {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /sysusers/getById {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /administrators/create {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/administrators/create;
    }

    location /administrators/update {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/administrators/update;
    }

    location /administrators/getAll {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/administrators/getAll;
    }

    location /users/create {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/users/create;
    }

    location /users/update {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/users/update;
    }

    location /users/getAll {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/users/getAll;
    }

    location /users/getById {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/getNotificationStatusesById {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /getIds {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/getIds;
    }

    location /users/changeWhetherIsPublic {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/users/changeWhetherIsPublic;
    }

    location /users/changeAllowedTags {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/users/changeAllowedTags;
    }

    location /users/updateVerification {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /agents/update {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/agents/update;
    }

    location /agents/create {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/agents/create;
    }

    location /agents/createRequest {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/agents/createRequest;
    }

    location /agents/declineRequest {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/agents/declineRequest;
    }

    location /agents/getAll {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/agents/getAll;
    }

    location /agents/getAllRequests {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/agents/getAllRequests;
    }

    location /users/isPublic {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/public-ids {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/users/public-ids;
    }

    location /profile/upload {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/upload;
    }

    location /profile/images {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /notify/create {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/notify/create;
    }

    location /notify/getAll {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }

    ###########################################################################################################
    ###########################################################################################################

    ###########################################################################################################
                                            # STORY SERVICE
    ###########################################################################################################

    location /story {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://story-service/story;
    }

    # location /upload {
    #     limit_except GET POST PUT OPTIONS DELETE { deny all; }
    #     proxy_pass http://story-service/upload;
    # }

    location /story/feed {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://story-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /story/paged-feed {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://story-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /story/my-paged-stories {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://story-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /story/my {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://story-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /story/highlight {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://story-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /story/remove-highlight {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://story-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /story/paged-highlights {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://story-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /story/images {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://story-service;
        rewrite ^/(.*)$ /$1 break;
    }

    ###########################################################################################################
    ###########################################################################################################

}
