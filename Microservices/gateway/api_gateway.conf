upstream auth-service {
    zone upstream-imageApp 64k;
    least_conn;
    server localhost:8080 max_fails=3 fail_timeout=60 weight=1;
}

upstream profile-service {
    zone upstream-profile 64k;
    least_conn;
    server localhost:8085 max_fails=3 fail_timeout=60 weight=1;
}

upstream post-service {
    zone upstream-post 64k;
    least_conn;
    server localhost:8086 max_fails=3 fail_timeout=60 weight=1;
}

upstream follower-service {
    zone upstream-follower 64k;
    least_conn;
    server localhost:8088 max_fails=3 fail_timeout=60 weight=1;
}

server {
    # listen 80;
    # server_name localhost;
    listen 443 ssl;
    ssl_certificate     ../certificates/certificate.pem;
    ssl_certificate_key ../certificates/certificate-key.pem;

    location / {
        add_header 'Access-Control-Allow-Origin' '*' always;
    }

    location /auth {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass https://auth-service; 
        rewrite ^/(.*)$ /$1 break;
    }

    location /images {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/create {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/users/create;
    }

    location /sysusers/getAllUsernames {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/sysusers/getAllUsernames;
    }

    location /users/getById/ {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /sysusers/getUserId {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service;
        rewrite ^/(.*)$ /$1 break;
    }
    # Profile service
    location /users/update {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://profile-service/users/update;
    }
    
    location /posts/public-tags {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/posts/public-tags;
    }

    location /posts/public-locations {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/posts/public-locations;
    }
    # Post service
    location /posts/signed-in-tags {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }
    # Post service
    location /posts/signed-in-locations {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }
    # Post service
    location /upload {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/upload;
    }
    # Post service
    location /posts/create {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/posts/create;
    }
    # Post service
    location /posts/feed {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://post-service/;
        rewrite ^/(.*)$ /$1 break;
    }

    location /posts/public {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/posts/public;
    }
    # Post service
    location /like-post {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/like-post;
    }
    # Post service
    location /dislike-post {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://post-service/dislike-post;
    }

    location /users/getFollowers {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service/;
        rewrite ^/(.*)$ /$1 break;
    }

    location /users/getFollowing {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service/;
        rewrite ^/(.*)$ /$1 break;
    }
    # Follower service
    location /users/getRequests {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service/;
        rewrite ^/(.*)$ /$1 break;
    }
    # Follower service
    location /users/follow {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service/;
        rewrite ^/(.*)$ /$1 break;
    }
    # Follower service
    location /users/unfollow {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service/;
        rewrite ^/(.*)$ /$1 break;
    }
    # Follower service
    location /users/acceptRequest {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://follower-service/;
        rewrite ^/(.*)$ /$1 break;
    }
}
